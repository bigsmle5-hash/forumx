<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ForumX ‚Äî —Å—Ç–∏–ª—å–Ω—ã–π —Ñ–æ—Ä—É–º (–±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞)</title>
  <meta name="description" content="–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π —Ñ–æ—Ä—É–º –≤ –æ–¥–Ω–æ–º HTML-—Ñ–∞–π–ª–µ. –•—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage. –ü–æ–∏—Å–∫, —Ç–µ–≥–∏, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –æ—Ç–≤–µ—Ç—ã, —Ç—ë–º–Ω–∞—è —Ç–µ–º–∞." />
  <style>
    :root {
      --bg: #0b0d10;
      --panel: #12151a;
      --muted: #8b97a7;
      --text: #e9eef5;
      --accent: #6aa9ff;
      --accent-2: #a46aff;
      --ok: #4ade80;
      --warn: #fbbf24;
      --danger: #f87171;
      --ring: rgba(106,169,255,.35);
      --shadow: 0 8px 24px rgba(0,0,0,.35);
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 10px;
    }
    :root.light {
      --bg: #f6f7fb;
      --panel: #ffffff;
      --muted: #64748b;
      --text: #0b1220;
      --accent: #2563eb;
      --accent-2: #7c3aed;
      --ok: #16a34a;
      --warn: #d97706;
      --danger: #dc2626;
      --ring: rgba(37,99,235,.25);
      --shadow: 0 10px 24px rgba(2,6,23,.08);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; background: linear-gradient(180deg, var(--bg), #0c1016 50%, var(--bg));
      color: var(--text); font: 16px/1.55 system-ui, -apple-system, Segoe UI, Roboto, Inter, "Segoe UI Variable", Arial, sans-serif;
      letter-spacing: .2px;
    }
    a { color: var(--accent); text-decoration: none; }
    a:hover{ text-decoration: underline; }
    .container {
      max-width: 1200px; margin: 0 auto; padding: 20px; display: grid; gap: 20px;
      grid-template-columns: 260px 1fr;
    }
    header.topbar {
      position: sticky; top: 0; z-index: 20; backdrop-filter: blur(8px);
      background: color-mix(in oklab, var(--bg) 84%, transparent);
      box-shadow: 0 1px 0 rgba(255,255,255,.05);
    }
    .topbar-inner { max-width: 1200px; margin: 0 auto; padding: 14px 20px; display: flex; align-items: center; gap: 14px; }
    .brand { display: flex; align-items: center; gap: 10px; font-weight: 800; letter-spacing: .4px; }
    .logo { width: 34px; height: 34px; border-radius: 9px; display: grid; place-items: center; color: #fff;
      background: conic-gradient(from 210deg, var(--accent), var(--accent-2)); box-shadow: var(--shadow);
    }
    .topbar .search { flex: 1; position: relative; }
    .search input {
      width: 100%; background: var(--panel); border: 1px solid rgba(255,255,255,.06);
      border-radius: 12px; padding: 12px 40px 12px 44px; color: var(--text);
      outline: none; box-shadow: 0 0 0 0 var(--ring); transition: box-shadow .2s, border-color .2s;
    }
    .search input:focus { box-shadow: 0 0 0 6px var(--ring); border-color: var(--accent); }
    .search .icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); opacity: .6; }
    .btn {
      background: linear-gradient(180deg, color-mix(in oklab, var(--accent), white 10%), var(--accent));
      border: 0; color: white; padding: 10px 14px; border-radius: 12px; font-weight: 600; cursor: pointer;
      box-shadow: var(--shadow);
    }
    .btn.secondary { background: var(--panel); color: var(--text); border: 1px solid rgba(255,255,255,.08); }
    .btn.ghost { background: transparent; border: 1px solid rgba(255,255,255,.08); color: var(--text); }
    .btn:disabled { opacity: .5; cursor: not-allowed; }

    .sidebar { position: sticky; top: 70px; align-self: start; display: grid; gap: 16px; }
    .card { background: color-mix(in oklab, var(--panel) 94%, transparent); border: 1px solid rgba(255,255,255,.06);
      border-radius: var(--radius-lg); padding: 16px; box-shadow: var(--shadow);
    }
    .card h3 { margin: 0 0 12px; font-size: 14px; text-transform: uppercase; letter-spacing: .12em; opacity: .8; }
    .tags { display: flex; gap: 8px; flex-wrap: wrap; }
    .tag { padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,.08); font-size: 13px; cursor: pointer; }
    .tag.active { border-color: var(--accent); color: var(--accent); background: rgba(106,169,255,.12); }

    .content { display: grid; gap: 16px; }

    .toolbar { display: flex; gap: 8px; align-items: center; justify-content: space-between; }
    .toolbar .left, .toolbar .right { display: flex; gap: 8px; align-items: center; }
    select, .input, textarea {
      background: var(--panel); color: var(--text); border: 1px solid rgba(255,255,255,.08); border-radius: 12px;
      padding: 10px 12px; outline: none;
    }
    select:focus, .input:focus, textarea:focus { box-shadow: 0 0 0 6px var(--ring); border-color: var(--accent); }

    .thread { display: grid; grid-template-columns: 1fr auto; gap: 10px; padding: 14px; border-bottom: 1px dashed rgba(255,255,255,.08); }
    .thread:last-child{ border-bottom: 0; }
    .thread .title { font-weight: 700; font-size: 18px; }
    .thread .meta { color: var(--muted); font-size: 13px; }
    .pill { padding: 2px 8px; border-radius: 999px; border: 1px solid rgba(255,255,255,.08); font-size: 12px; }

    .pagination { display: flex; gap: 8px; justify-content: center; align-items: center; margin-top: 8px; }
    .pagination button { padding: 8px 12px; }

    /* Thread view */
    .back { display: inline-flex; align-items: center; gap: 8px; font-size: 14px; opacity: .9; }
    .thread-view { display: grid; gap: 16px; }
    .post { background: var(--panel); border: 1px solid rgba(255,255,255,.08); border-radius: var(--radius-md); padding: 14px; box-shadow: var(--shadow); }
    .post .post-head { display: flex; justify-content: space-between; align-items: center; }
    .post .author { font-weight: 700; }
    .post .body { margin-top: 10px; white-space: pre-wrap; word-break: break-word; }
    .post .actions { display: flex; gap: 6px; }
    .reply { margin-left: 28px; border-left: 2px dashed rgba(255,255,255,.08); padding-left: 12px; }

    .editor { display: grid; gap: 8px; }
    .hint { color: var(--muted); font-size: 13px; }

    .modal {
      position: fixed; inset: 0; display: none; place-items: center; z-index: 50;
      background: rgba(0,0,0,.5); backdrop-filter: blur(2px);
    }
    .modal.active { display: grid; }
    .modal .panel { width: min(680px, 92vw); background: var(--panel); border: 1px solid rgba(255,255,255,.08); border-radius: 18px; padding: 16px; box-shadow: var(--shadow); }

    .toolbar .theme { padding: 8px 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,.08); background: var(--panel); cursor: pointer; }

    .empty { text-align: center; color: var(--muted); padding: 24px; border: 1px dashed rgba(255,255,255,.12); border-radius: var(--radius-lg); }

    @media (max-width: 980px){ .container { grid-template-columns: 1fr; } .sidebar { position: static; } }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">‚òÖ</div>
        <div>ForumX</div>
      </div>
      <div class="search">
        <svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        <input id="q" type="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É, —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É –∏ —Ç–µ–≥–∞–º (Ctrl+/)" />
      </div>
      <button class="btn" id="newThreadBtn">+ –ù–æ–≤–∞—è —Ç–µ–º–∞</button>
      <button class="theme" id="themeBtn" title="–¢—ë–º–Ω–∞—è/—Å–≤–µ—Ç–ª–∞—è">üåì</button>
      <button class="btn secondary" id="userBtn" title="–ü—Ä–æ—Ñ–∏–ª—å">üë§ <span id="userNameLabel"></span></button>
    </div>
  </header>

  <main class="container">
    <aside class="sidebar">
      <section class="card" id="catsCard">
        <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
        <div class="tags" id="cats"></div>
      </section>
      <section class="card">
        <h3>–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–µ–≥–∏</h3>
        <div class="tags" id="popularTags"></div>
      </section>
      <section class="card">
        <h3>–°–ø—Ä–∞–≤–∫–∞</h3>
        <div class="hint">–•—Ä–∞–Ω–∏–ª–∏—â–µ ‚Äî <b>localStorage</b>. –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ API/–ë–î. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ <b>–º–∏–∫—Ä–æ‚ÄëMarkdown</b>: **–∂–∏—Ä–Ω—ã–π**, *–∫—É—Ä—Å–∏–≤*, `–∫–æ–¥`, —Å—Å—ã–ª–∫–∏ http(s)://‚Ä¶</div>
      </section>
    </aside>

    <section class="content">
      <div class="toolbar">
        <div class="left">
          <select id="sort">
            <option value="new">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
            <option value="top">–ü–æ –æ—Ç–≤–µ—Ç–∞–º</option>
            <option value="active">–ù–µ–¥–∞–≤–Ω–æ –∞–∫—Ç–∏–≤–Ω—ã–µ</option>
          </select>
          <select id="perPage">
            <option value="5">5 –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É</option>
            <option value="10" selected>10 –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É</option>
            <option value="20">20 –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É</option>
          </select>
        </div>
        <div class="right">
          <span class="hint" id="countLabel"></span>
        </div>
      </div>

      <div class="card" id="listView">
        <div id="threads"></div>
        <div class="pagination" id="pager"></div>
      </div>

      <div class="thread-view" id="threadView" style="display:none"></div>
    </section>
  </main>

  <!-- –ú–æ–¥–∞–ª–∫–∏ -->
  <div class="modal" id="newThreadModal">
    <div class="panel">
      <h2 style="margin:0 0 8px">–ù–æ–≤–∞—è —Ç–µ–º–∞</h2>
      <div class="editor">
        <input id="ntTitle" class="input" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" />
        <div style="display:flex; gap:8px">
          <input id="ntCategory" class="input" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è (–Ω–∞–ø—Ä. '–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞')" />
          <input id="ntTags" class="input" placeholder="–¢–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–∞–ø—Ä. ui,react,help)" />
        </div>
        <textarea id="ntBody" rows="6" placeholder="–¢–µ–∫—Å—Ç –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ **–∂–∏—Ä–Ω–æ–≥–æ**, *–∫—É—Ä—Å–∏–≤–∞*, `–∫–æ–¥–∞`, —Å—Å—ã–ª–æ–∫)"></textarea>
        <div style="display:flex; gap:8px; justify-content:flex-end">
          <button class="btn ghost" data-close>–û—Ç–º–µ–Ω–∞</button>
          <button class="btn" id="ntCreate">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="userModal">
    <div class="panel">
      <h2 style="margin:0 0 8px">–í–∞—à–µ –∏–º—è</h2>
      <div class="editor">
        <input id="userName" class="input" placeholder="–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è" />
        <div class="hint">–ò–º—è –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å—Å—è —Ä—è–¥–æ–º —Å –≤–∞—à–∏–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏. –•—Ä–∞–Ω–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.</div>
        <div style="display:flex; gap:8px; justify-content:flex-end">
          <button class="btn ghost" data-close>–û—Ç–º–µ–Ω–∞</button>
          <button class="btn" id="saveUser">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // ======= –£–¢–ò–õ–´ =======
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const uid = () => `${Date.now().toString(36)}${Math.random().toString(36).slice(2,8)}`;
    const fmtDate = ts => new Date(ts).toLocaleString();
    const escapeHtml = (str) => str.replace(/[&<>"]|'/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
    const mdLite = (str) => {
      // –ü—Ä–æ—Å—Ç–æ–π Markdown –ø–æ—Å–ª–µ —ç—Å–∫–µ–π–ø–∞ HTML
      let s = escapeHtml(str);
      s = s.replace(/\*\*(.+?)\*\*/g, '<b>$1</b>')
           .replace(/\*(.+?)\*/g, '<i>$1</i>')
           .replace(/`([^`]+)`/g, '<code>$1<\/code>')
           .replace(/(https?:\/\/[\w\-._~:?#\[\]@!$&'()*+,;=%/]+)(?![^<]*>)/g, '<a href="$1" target="_blank" rel="noopener">$1<\/a>');
      return s;
    };

    const DB_KEY = 'forumx.v1';

    const blank = () => ({
      users: {},
      categories: ['–û–±—â–µ–µ', '–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞', '–î–∏–∑–∞–π–Ω', '–£—á—ë–±–∞', '–û—Ñ—Ñ—Ç–æ–ø'],
      threads: [], // {id, title, category, tags[], createdAt, updatedAt, author, postsCount, lastActivityAt}
      posts: {},   // posts[threadId] = [{id, parentId|null, author, body, createdAt}]
    });

    const getState = () => {
      try {
        const raw = localStorage.getItem(DB_KEY);
        if (!raw) return seed();
        const obj = JSON.parse(raw);
        return obj;
      } catch (e) {
        console.error('STATE_PARSE', e);
        return seed();
      }
    };

    const setState = (s) => localStorage.setItem(DB_KEY, JSON.stringify(s));

    const seed = () => {
      const s = blank();
      const author = '–ê–¥–º–∏–Ω';
      const t1 = createThreadLocal(s, { title: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ ForumX!', category: '–û–±—â–µ–µ', tags: ['–ø—Ä–∞–≤–∏–ª–∞','—Å—Ç–∞—Ä—Ç'], body: '–≠—Ç–æ —Ñ–æ—Ä—É–º –≤ –æ–¥–Ω–æ–º HTML‚Äë—Ñ–∞–π–ª–µ. –°–æ–∑–¥–∞–≤–∞–π—Ç–µ —Ç–µ–º—ã, –æ—Ç–≤–µ—á–∞–π—Ç–µ, –ø—Ä–æ–±—É–π—Ç–µ —Ç—ë–º–Ω—É—é —Ç–µ–º—É. –£–¥–∞—á–∏! *–ü–∏—à–∏—Ç–µ –∫—É–ª—å—Ç—É—Ä–Ω–æ.*', author });
      addReplyLocal(s, t1.id, null, { author: 'Bot', body: '–ü–æ–¥—Å–∫–∞–∑–∫–∞: –Ω–∞–∂–º–∏—Ç–µ üåì –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã.' });
      const t2 = createThreadLocal(s, { title: '–ü–æ–∫–∞–∂–∏—Ç–µ —Å–≤–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã', category: '–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞', tags: ['projects','showcase'], body: '–î–µ–ª–∏–º—Å—è —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ –ø—Ä–æ–µ–∫—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ–≥–∏, —á—Ç–æ–±—ã –±—ã–ª–æ –ø—Ä–æ—â–µ –∏—Å–∫–∞—Ç—å.', author });
      setState(s);
      return s;
    };

    const createThreadLocal = (s, { title, category, tags, body, author }) => {
      const id = uid();
      const now = Date.now();
      const entry = { id, title, category, tags: tags?.map(t=>t.trim()).filter(Boolean) || [], createdAt: now, updatedAt: now, author: author || '–ê–Ω–æ–Ω–∏–º', postsCount: 1, lastActivityAt: now };
      s.threads.unshift(entry);
      s.posts[id] = [{ id: uid(), parentId: null, author: author || '–ê–Ω–æ–Ω–∏–º', body, createdAt: now }];
      return entry;
    };

    const addReplyLocal = (s, threadId, parentId, { author, body }) => {
      const p = { id: uid(), parentId: parentId || null, author: author || '–ê–Ω–æ–Ω–∏–º', body, createdAt: Date.now() };
      s.posts[threadId].push(p);
      const th = s.threads.find(t=>t.id===threadId);
      th.postsCount++;
      th.lastActivityAt = p.createdAt;
      th.updatedAt = p.createdAt;
      return p;
    };

    // ======= –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï UI =======
    let S = getState();
    let currentThreadId = null;
    let currentTag = null;
    let currentCategory = null;
    let currentPage = 1;

    // ======= –†–ï–ù–î–ï–† –°–ü–ò–°–ö–ê =======
    const perPageSel = $('#perPage');
    const sortSel = $('#sort');
    const qInput = $('#q');

    function filteredThreads(){
      const q = qInput.value.trim().toLowerCase();
      let list = S.threads.slice();
      if (currentCategory) list = list.filter(t=>t.category===currentCategory);
      if (currentTag) list = list.filter(t=>t.tags.includes(currentTag));
      if (q) {
        list = list.filter(t=>{
          const posts = S.posts[t.id]||[];
          const hay = [t.title, t.tags.join(','), ...posts.map(p=>p.body)].join(' ').toLowerCase();
          return hay.includes(q);
        });
      }
      const sort = sortSel.value;
      if (sort==='new') list.sort((a,b)=>b.createdAt - a.createdAt);
      if (sort==='top') list.sort((a,b)=>b.postsCount - a.postsCount || b.createdAt - a.createdAt);
      if (sort==='active') list.sort((a,b)=>b.lastActivityAt - a.lastActivityAt);
      return list;
    }

    function renderList(){
      $('#threadView').style.display = 'none';
      $('#listView').style.display = 'block';

      const list = filteredThreads();
      const per = parseInt(perPageSel.value,10);
      const pages = Math.max(1, Math.ceil(list.length / per));
      if (currentPage>pages) currentPage=pages;
      const start = (currentPage-1)*per;
      const pageItems = list.slice(start, start+per);

      $('#countLabel').textContent = `–¢–µ–º: ${list.length} ‚Ä¢ –°—Ç—Ä. ${currentPage}/${pages}`;

      const c = $('#threads');
      c.innerHTML = '';
      if (!pageItems.length){
        c.innerHTML = `<div class="empty">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–±—Ä–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å.</div>`;
      } else {
        for (const t of pageItems){
          const el = document.createElement('div');
          el.className = 'thread';
          el.innerHTML = `
            <div>
              <div class="title"><a href="#" data-open="${t.id}">${escapeHtml(t.title)}</a></div>
              <div class="meta">–ö–∞—Ç–µ–≥–æ—Ä–∏—è: <b>${escapeHtml(t.category)}</b> ‚Ä¢ –û—Ç–≤–µ—Ç–æ–≤: ${t.postsCount-1} ‚Ä¢ –û–±–Ω–æ–≤–ª–µ–Ω–æ: ${fmtDate(t.lastActivityAt)}
                ${t.tags?.length? ' ‚Ä¢ ' + t.tags.map(tag=>`<span class="pill">#${escapeHtml(tag)}</span>`).join(' ') : ''}
              </div>
            </div>
            <div><span class="pill">–ê–≤—Ç–æ—Ä: ${escapeHtml(t.author)}</span></div>
          `;
          c.appendChild(el);
        }
      }

      const p = $('#pager');
      p.innerHTML = '';
      const mkBtn = (txt, disabled, onClick) => {
        const b = document.createElement('button');
        b.className = 'btn secondary'; b.textContent = txt; b.disabled = disabled; b.addEventListener('click', onClick); return b;
      };
      p.append(mkBtn('‚ü®‚ü®', currentPage===1, ()=>{ currentPage=1; renderList(); }),
               mkBtn('‚ü®', currentPage===1, ()=>{ currentPage--; renderList(); }),
               mkBtn('‚ü©', currentPage===pages, ()=>{ currentPage++; renderList(); }),
               mkBtn('‚ü©‚ü©', currentPage===pages, ()=>{ currentPage=pages; renderList(); }));

      // –∫–ª–∏–∫–∏ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º
      $$('#threads a[data-open]').forEach(a=>a.addEventListener('click', (e)=>{
        e.preventDefault();
        openThread(a.getAttribute('data-open'));
      }));
    }

    // ======= –†–ï–ù–î–ï–† –ö–ê–¢–ï–ì–û–†–ò–ô/–¢–ï–ì–û–í =======
    function renderCats(){
      const cats = $('#cats');
      cats.innerHTML='';
      const all = document.createElement('span');
      all.className = 'tag' + (currentCategory? '': ' active');
      all.textContent = '–í—Å–µ';
      all.addEventListener('click', ()=>{ currentCategory=null; currentPage=1; renderList(); });
      cats.appendChild(all);
      for (const c of S.categories){
        const el = document.createElement('span');
        el.className = 'tag' + (currentCategory===c? ' active': '');
        el.textContent = c;
        el.addEventListener('click', ()=>{ currentCategory=c; currentPage=1; renderList(); });
        cats.appendChild(el);
      }
    }

    function renderPopularTags(){
      const map = new Map();
      for (const t of S.threads){
        for (const tag of (t.tags||[])) map.set(tag, (map.get(tag)||0)+1);
      }
      const top = [...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,12).map(([name])=>name);
      const box = $('#popularTags'); box.innerHTML='';
      const all = document.createElement('span');
      all.className = 'tag' + (currentTag? '': ' active');
      all.textContent = '–í—Å–µ';
      all.addEventListener('click', ()=>{ currentTag=null; currentPage=1; renderList(); });
      box.appendChild(all);
      for (const t of top){
        const el = document.createElement('span');
        el.className = 'tag' + (currentTag===t? ' active': '');
        el.textContent = `#${t}`;
        el.addEventListener('click', ()=>{ currentTag=t; currentPage=1; renderList(); });
        box.appendChild(el);
      }
    }

    // ======= –û–¢–ö–†–´–¢–ò–ï –¢–ï–ú–´ =======
    function openThread(id){
      currentThreadId = id;
      $('#listView').style.display = 'none';
      const box = $('#threadView');
      box.style.display = 'grid';
      const th = S.threads.find(t=>t.id===id);
      const posts = (S.posts[id]||[]);

      const postHtml = (p, isReply=false) => `
        <div class="post ${isReply?'reply':''}">
          <div class="post-head">
            <div class="author">${escapeHtml(p.author)}</div>
            <div class="meta">${fmtDate(p.createdAt)}</div>
          </div>
          <div class="body">${mdLite(p.body)}</div>
          <div class="actions">
            <button class="btn ghost" data-reply="${p.id}">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
          </div>
        </div>`;

      let html = `<a href="#" class="back" id="back">‚üµ –ö —Å–ø–∏—Å–∫—É</a>
                  <h1 style="margin:0">${escapeHtml(th.title)}</h1>
                  <div class="hint">–ö–∞—Ç–µ–≥–æ—Ä–∏—è: <b>${escapeHtml(th.category)}</b>${th.tags?.length? ' ‚Ä¢ ' + th.tags.map(t=>`<span class=\"pill\">#${escapeHtml(t)}<\/span>`).join(' '): ''} ‚Ä¢ –ê–≤—Ç–æ—Ä: ${escapeHtml(th.author)} ‚Ä¢ –°–æ–æ–±—â–µ–Ω–∏–π: ${th.postsCount}</div>
                  <div id="posts">`;

      // –¥–µ—Ä–µ–≤–æ: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º 1–π –ø–æ—Å—Ç, –∑–∞—Ç–µ–º –æ—Ç–≤–µ—Ç—ã/–≤–ª–æ–∂–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
      const roots = posts.filter(p=>!p.parentId);
      const children = posts.filter(p=>p.parentId);
      const childMap = new Map();
      for (const c of children){
        const arr = childMap.get(c.parentId)||[]; arr.push(c); childMap.set(c.parentId, arr);
      }
      for (const r of roots){
        html += postHtml(r, false);
        const lvl1 = (childMap.get(r.id)||[]).sort((a,b)=>a.createdAt-b.createdAt);
        for (const c of lvl1){
          html += postHtml(c, true);
          const lvl2 = (childMap.get(c.id)||[]).sort((a,b)=>a.createdAt-b.createdAt);
          for (const d of lvl2){ html += postHtml(d, true); }
        }
      }
      html += '</div>';

      // —Ä–µ–¥–∞–∫—Ç–æ—Ä –æ—Ç–≤–µ—Ç–∞
      html += `
        <div class="card">
          <div class="editor">
            <textarea id="replyText" rows="5" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ **–∂–∏—Ä–Ω–æ–≥–æ**, *–∫—É—Ä—Å–∏–≤–∞*, `+"`–∫–æ–¥–∞`"+`, —Å—Å—ã–ª–æ–∫)"></textarea>
            <div style="display:flex; gap:8px; justify-content:flex-end">
              <button class="btn" id="sendReply">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
            </div>
            <div class="hint">–û—Ç–≤–µ—á–∞–µ—Ç–µ –∫–∞–∫: <b id="who"></b>. <a href="#" id="switchUser">—Å–º–µ–Ω–∏—Ç—å –∏–º—è</a></div>
          </div>
        </div>`;

      box.innerHTML = html;

      $('#back').addEventListener('click', (e)=>{ e.preventDefault(); renderList(); });
      $$('#posts button[data-reply]').forEach(b=>b.addEventListener('click', ()=>{
        const id = b.getAttribute('data-reply');
        const t = $('#replyText');
        t.focus(); t.value = t.value + `\n> –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (${id.slice(-4)}). `;
      }));
      $('#who').textContent = (S.users.me?.name)||'–ê–Ω–æ–Ω–∏–º';
      $('#switchUser').addEventListener('click', (e)=>{ e.preventDefault(); openUserModal(); });
      $('#sendReply').addEventListener('click', ()=>{
        const body = $('#replyText').value.trim();
        if (!body) return alert('–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç');
        const author = (S.users.me?.name)||'–ê–Ω–æ–Ω–∏–º';
        addReplyLocal(S, th.id, null, { author, body });
        setState(S); openThread(th.id);
      });
    }

    // ======= –ú–û–î–ê–õ–ö–ò =======
    function bindModal(mod){
      mod.querySelectorAll('[data-close]').forEach(x=>x.addEventListener('click', ()=>mod.classList.remove('active')));
      mod.addEventListener('click', (e)=>{ if (e.target===mod) mod.classList.remove('active'); });
    }
    bindModal($('#newThreadModal'));
    bindModal($('#userModal'));

    // ======= –°–û–ó–î–ê–ù–ò–ï –¢–ï–ú–´ =======
    function openNewThread(){ $('#newThreadModal').classList.add('active'); $('#ntTitle').focus(); }
    $('#newThreadBtn').addEventListener('click', openNewThread);

    $('#ntCreate').addEventListener('click', ()=>{
      const title = $('#ntTitle').value.trim();
      const category = $('#ntCategory').value.trim() || '–û–±—â–µ–µ';
      const tags = $('#ntTags').value.split(',').map(s=>s.trim()).filter(Boolean);
      const body = $('#ntBody').value.trim();
      if (!title || !body) return alert('–ù—É–∂–Ω—ã –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ç–µ–∫—Å—Ç');
      const author = (S.users.me?.name)||'–ê–Ω–æ–Ω–∏–º';
      const th = createThreadLocal(S, { title, category, tags, body, author });
      if (!S.categories.includes(category)) S.categories.push(category);
      setState(S);
      $('#newThreadModal').classList.remove('active');
      // –æ—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
      $('#ntTitle').value=''; $('#ntCategory').value=''; $('#ntTags').value=''; $('#ntBody').value='';
      renderCats(); renderPopularTags();
      openThread(th.id);
    });

    // ======= –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ =======
    function openUserModal(){ $('#userModal').classList.add('active'); const i=$('#userName'); i.value=S.users.me?.name||''; i.focus(); }
    $('#userBtn').addEventListener('click', openUserModal);
    $('#saveUser').addEventListener('click', ()=>{
      const name = $('#userName').value.trim() || '–ê–Ω–æ–Ω–∏–º';
      S.users.me = { name };
      setState(S);
      $('#userModal').classList.remove('active');
      updateUserLabel();
      if (currentThreadId) openThread(currentThreadId); // –æ–±–Ω–æ–≤–∏–º –ø–æ–¥–ø–∏—Å—å –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ
    });
    function updateUserLabel(){ $('#userNameLabel').textContent = S.users.me?.name || '–ê–Ω–æ–Ω–∏–º'; }

    // ======= –ü–û–ò–°–ö/–§–ò–õ–¨–¢–†–´/–°–û–†–¢ =======
    perPageSel.addEventListener('change', ()=>{ currentPage=1; renderList(); });
    sortSel.addEventListener('change', ()=>{ currentPage=1; renderList(); });
    qInput.addEventListener('input', ()=>{ currentPage=1; renderList(); });
    window.addEventListener('keydown', (e)=>{ if (e.ctrlKey && e.key === '/') { e.preventDefault(); qInput.focus(); }});

    // ======= –¢–ï–ú–ê (LIGHT/DARK) =======
    const themeBtn = $('#themeBtn');
    function setTheme(mode){ document.documentElement.classList.toggle('light', mode==='light'); localStorage.setItem('forumx.theme', mode); }
    function toggleTheme(){ const cur = localStorage.getItem('forumx.theme')||'dark'; setTheme(cur==='dark'?'light':'dark'); }
    themeBtn.addEventListener('click', toggleTheme);
    setTheme(localStorage.getItem('forumx.theme')||'dark');

    // ======= –°–¢–ê–†–¢ =======
    function start(){
      updateUserLabel();
      renderCats();
      renderPopularTags();
      renderList();
    }
    start();

    // –≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ—Å—Ç–æ–≥–æ API –≤ window (–¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è)
    window.ForumX = {
      getState: () => JSON.parse(JSON.stringify(S)),
      reset: () => { localStorage.removeItem(DB_KEY); S = seed(); start(); },
      export: () => { const blob = new Blob([localStorage.getItem(DB_KEY)||'{}'], {type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='forumx-data.json'; a.click(); },
      import: (obj) => { try{ setState(obj); S=getState(); start(); } catch(e){ alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞'); } }
    };
  </script>
</body>
</html>
